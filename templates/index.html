<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f6f8;
        }
        .navbar {
            margin-bottom: 30px;
        }
        .task-table td {
            vertical-align: middle;
        }
        #auth-section {
            max-width: 420px;
            margin: 60px auto;
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
        }
        .status-done { background-color: #198754; }
        .status-pending { background-color: #dc3545; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark px-4">
        <span class="navbar-brand fw-bold">Task Manager</span>
        <div class="d-flex align-items-center">
            <span id="nav-username" class="text-white me-3 small"></span>
            <button class="btn btn-sm btn-outline-light" id="logout-btn" style="display:none" onclick="doLogout()">Logout</button>
        </div>
    </nav>

    <div class="container">

        <!-- login / register section -->
        <div id="auth-section">
            <ul class="nav nav-tabs mb-3" id="authTabs">
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="switchTab('login'); return false;">Login</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="switchTab('register'); return false;">Register</a>
                </li>
            </ul>

            <div id="login-form">
                <div class="card p-4 shadow-sm">
                    <h5 class="mb-3">Login to your account</h5>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="login-username" placeholder="Username">
                    </div>
                    <div class="mb-3">
                        <input type="password" class="form-control" id="login-password" placeholder="Password">
                    </div>
                    <button class="btn btn-primary w-100" onclick="doLogin()">Login</button>
                    <div id="login-error" class="text-danger mt-2 small" style="display:none"></div>
                </div>
            </div>

            <div id="register-form" style="display:none">
                <div class="card p-4 shadow-sm">
                    <h5 class="mb-3">Create account</h5>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="reg-username" placeholder="Username">
                    </div>
                    <div class="mb-2">
                        <input type="email" class="form-control" id="reg-email" placeholder="Email (optional)">
                    </div>
                    <div class="mb-3">
                        <input type="password" class="form-control" id="reg-password" placeholder="Password">
                    </div>
                    <button class="btn btn-success w-100" onclick="doRegister()">Register</button>
                    <div id="reg-error" class="text-danger mt-2 small" style="display:none"></div>
                    <div id="reg-success" class="text-success mt-2 small" style="display:none"></div>
                </div>
            </div>
        </div>

        <!-- tasks section (visible after login) -->
        <div id="task-section" style="display:none">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">My Tasks</h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" id="filter-completed" onchange="loadTasks(1)">
                        <option value="">All Tasks</option>
                        <option value="true">Completed</option>
                        <option value="false">Pending</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="openAddModal()">+ Add Task</button>
                </div>
            </div>

            <div class="card shadow-sm">
                <table class="table table-hover mb-0 task-table">
                    <thead class="table-dark">
                        <tr>
                            <th style="width:40px">#</th>
                            <th>Title</th>
                            <th>Description</th>
                            <th style="width:110px">Status</th>
                            <th style="width:100px">Created</th>
                            <th style="width:130px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="task-tbody">
                        <tr><td colspan="6" class="text-center py-3 text-muted">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="pagination" class="d-flex gap-2 mt-3"></div>
        </div>

    </div>

    <!-- task add/edit modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">Add Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-task-id">
                    <div class="mb-3">
                        <label class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="modal-title-input" placeholder="Enter task title">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="modal-desc-input" rows="3" placeholder="Task description (optional)"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="modal-completed-input">
                        <label class="form-check-label">Mark as completed</label>
                    </div>
                    <div id="modal-error" class="text-danger mt-2 small" style="display:none"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        var BASE_URL = '/api';
        var currentPage = 1;

        // store tasks so edit modal can use them without inline data in onclick
        var tasksCache = {};

        window.onload = function() {
            var token = localStorage.getItem('access_token');
            if (token) {
                showAppSection(localStorage.getItem('username'));
                loadTasks(1);
            }
        };

        function switchTab(tabName) {
            var showLogin = tabName === 'login';
            document.getElementById('login-form').style.display = showLogin ? 'block' : 'none';
            document.getElementById('register-form').style.display = showLogin ? 'none' : 'block';
            var tabs = document.querySelectorAll('#authTabs .nav-link');
            tabs[0].classList.toggle('active', showLogin);
            tabs[1].classList.toggle('active', !showLogin);
        }

        async function doLogin() {
            var username = document.getElementById('login-username').value.trim();
            var password = document.getElementById('login-password').value;
            var errEl = document.getElementById('login-error');
            errEl.style.display = 'none';

            if (!username || !password) {
                errEl.textContent = 'Please fill in all fields';
                errEl.style.display = 'block';
                return;
            }

            try {
                const resp = await fetch(BASE_URL + '/auth/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, password: password })
                });
                const data = await resp.json();

                if (!resp.ok) {
                    errEl.textContent = data.error || 'Login failed, check your credentials';
                    errEl.style.display = 'block';
                    return;
                }

                localStorage.setItem('access_token', data.access);
                localStorage.setItem('refresh_token', data.refresh);
                localStorage.setItem('username', data.user.username);
                showAppSection(data.user.username);
                loadTasks(1);
            } catch(err) {
                errEl.textContent = 'Something went wrong, try again';
                errEl.style.display = 'block';
            }
        }

        async function doRegister() {
            var username = document.getElementById('reg-username').value.trim();
            var email = document.getElementById('reg-email').value.trim();
            var password = document.getElementById('reg-password').value;
            var errEl = document.getElementById('reg-error');
            var sucEl = document.getElementById('reg-success');
            errEl.style.display = 'none';
            sucEl.style.display = 'none';

            if (!username || !password) {
                errEl.textContent = 'Username and password are required';
                errEl.style.display = 'block';
                return;
            }

            try {
                const resp = await fetch(BASE_URL + '/auth/register/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, email: email, password: password })
                });
                const data = await resp.json();

                if (!resp.ok) {
                    // flatten validation errors
                    var msgs = [];
                    for (var key in data) {
                        if (Array.isArray(data[key])) {
                            msgs = msgs.concat(data[key]);
                        }
                    }
                    errEl.textContent = msgs.join(', ') || 'Registration failed';
                    errEl.style.display = 'block';
                    return;
                }

                sucEl.textContent = 'Account created! You can now login.';
                sucEl.style.display = 'block';
                setTimeout(function() { switchTab('login'); }, 1500);
            } catch(err) {
                errEl.textContent = 'Something went wrong';
                errEl.style.display = 'block';
            }
        }

        function showAppSection(username) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('task-section').style.display = 'block';
            document.getElementById('nav-username').textContent = 'Hello, ' + username;
            document.getElementById('logout-btn').style.display = 'inline-block';
        }

        function doLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('username');
            tasksCache = {};
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('task-section').style.display = 'none';
            document.getElementById('nav-username').textContent = '';
            document.getElementById('logout-btn').style.display = 'none';
        }

        async function loadTasks(page) {
            if (page) currentPage = page;
            var token = localStorage.getItem('access_token');
            var filterVal = document.getElementById('filter-completed').value;

            var url = BASE_URL + '/tasks/?page=' + currentPage;
            if (filterVal !== '') {
                url = url + '&completed=' + filterVal;
            }

            try {
                const resp = await fetch(url, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await resp.json();
                renderTasks(data.results || []);
                renderPagination(data.next, data.previous);
            } catch(err) {
                document.getElementById('task-tbody').innerHTML =
                    '<tr><td colspan="6" class="text-center text-danger py-3">Failed to load tasks</td></tr>';
            }
        }

        function renderTasks(tasks) {
            var tbody = document.getElementById('task-tbody');

            if (tasks.length == 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">No tasks yet</td></tr>';
                return;
            }

            // save tasks in cache so edit modal can access by id
            tasksCache = {};
            tasks.forEach(function(t) {
                tasksCache[t.id] = t;
            });

            var rows = '';
            for (var i = 0; i < tasks.length; i++) {
                var t = tasks[i];
                var rowNum = (currentPage - 1) * 10 + i + 1;
                var statusBadge = t.completed
                    ? '<span class="status-badge status-done">Completed</span>'
                    : '<span class="status-badge status-pending">Pending</span>';
                var createdDate = new Date(t.created_at).toLocaleDateString();

                rows += '<tr>';
                rows += '<td>' + rowNum + '</td>';
                rows += '<td>' + escapeHtml(t.title) + '</td>';
                rows += '<td>' + escapeHtml(t.description || '') + '</td>';
                rows += '<td>' + statusBadge + '</td>';
                rows += '<td>' + createdDate + '</td>';
                rows += '<td>';
                rows += '<button class="btn btn-sm btn-warning me-1" onclick="openEditModal(' + t.id + ')">Edit</button>';
                rows += '<button class="btn btn-sm btn-danger" onclick="deleteTask(' + t.id + ')">Delete</button>';
                rows += '</td>';
                rows += '</tr>';
            }
            tbody.innerHTML = rows;
        }

        function renderPagination(next, previous) {
            var el = document.getElementById('pagination');
            el.innerHTML = '';

            if (previous) {
                var prevBtn = document.createElement('button');
                prevBtn.className = 'btn btn-sm btn-outline-secondary';
                prevBtn.textContent = '← Previous';
                prevBtn.onclick = function() { loadTasks(currentPage - 1); };
                el.appendChild(prevBtn);
            }
            if (next) {
                var nextBtn = document.createElement('button');
                nextBtn.className = 'btn btn-sm btn-outline-secondary';
                nextBtn.textContent = 'Next →';
                nextBtn.onclick = function() { loadTasks(currentPage + 1); };
                el.appendChild(nextBtn);
            }
        }

        function openAddModal() {
            document.getElementById('modal-title').textContent = 'Add Task';
            document.getElementById('edit-task-id').value = '';
            document.getElementById('modal-title-input').value = '';
            document.getElementById('modal-desc-input').value = '';
            document.getElementById('modal-completed-input').checked = false;
            document.getElementById('modal-error').style.display = 'none';
            var modal = new bootstrap.Modal(document.getElementById('taskModal'));
            modal.show();
        }

        function openEditModal(taskId) {
            // get task data from cache instead of passing it inline
            var task = tasksCache[taskId];
            if (!task) {
                alert('Could not find task data, please refresh');
                return;
            }

            document.getElementById('modal-title').textContent = 'Edit Task';
            document.getElementById('edit-task-id').value = task.id;
            document.getElementById('modal-title-input').value = task.title;
            document.getElementById('modal-desc-input').value = task.description || '';
            document.getElementById('modal-completed-input').checked = task.completed;
            document.getElementById('modal-error').style.display = 'none';
            var modal = new bootstrap.Modal(document.getElementById('taskModal'));
            modal.show();
        }

        async function saveTask() {
            var token = localStorage.getItem('access_token');
            var taskId = document.getElementById('edit-task-id').value;
            var title = document.getElementById('modal-title-input').value.trim();
            var description = document.getElementById('modal-desc-input').value.trim();
            var completed = document.getElementById('modal-completed-input').checked;
            var errEl = document.getElementById('modal-error');
            errEl.style.display = 'none';

            if (!title) {
                errEl.textContent = 'Title cant be empty';
                errEl.style.display = 'block';
                return;
            }

            var isEdit = taskId !== '';
            var url = isEdit ? (BASE_URL + '/tasks/' + taskId + '/') : (BASE_URL + '/tasks/');
            var method = isEdit ? 'PUT' : 'POST';

            try {
                const resp = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        completed: completed
                    })
                });
                const data = await resp.json();

                if (!resp.ok) {
                    var msgs = [];
                    for (var key in data) {
                        if (Array.isArray(data[key])) msgs = msgs.concat(data[key]);
                        else msgs.push(data[key]);
                    }
                    errEl.textContent = msgs.join(', ') || 'Failed to save task';
                    errEl.style.display = 'block';
                    return;
                }

                var modalEl = document.getElementById('taskModal');
                bootstrap.Modal.getInstance(modalEl).hide();
                loadTasks(currentPage);
            } catch(err) {
                errEl.textContent = 'Something went wrong';
                errEl.style.display = 'block';
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Delete this task? This cannot be undone.')) return;

            var token = localStorage.getItem('access_token');
            try {
                const resp = await fetch(BASE_URL + '/tasks/' + taskId + '/', {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (resp.status === 204) {
                    loadTasks(currentPage);
                } else {
                    alert('Could not delete this task');
                }
            } catch(err) {
                alert('Something went wrong');
            }
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(String(str)));
            return div.innerHTML;
        }

    </script>
</body>
</html>
